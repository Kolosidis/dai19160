<!doctype html>
<html lang="el">

    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" 
                    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" 
                    crossorigin="anonymous">
        <title>Lottery App</title>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row p-5">
                <div class="col-4"></div>
                <div class="col-4 text-center">
                    <div class="h2">Lottery - Ballot</div>
                </div>
                <div class="col-4"></div>
            </div>
            <div class="row p-5">
                <div class="col-4 d-flex justify-content-center">
                    <div class="card" style="width: 18rem;">
                        <img src="./images/car-image.jpg" class="card-img-top" alt="Photo of a mercedez car">
                        <div class="card-body">
                          <p class="card-text">Enter the Lottery to have a change to win a new car</p>
                          <button type="button" style="width: 5rem" class="btn btn-primary" id="car">Bid</button>
                          <div id="car-bids" class="h3 d-inline float-end"></div>
                        </div>
                      </div>
                </div>
                <div class="col-4 d-flex justify-content-center">
                    <div class="card" style="width: 18rem;">
                        <img src="./images/Apple-iPhone-XR-64GB.jpg" class="card-img-top" alt= "Photo of Iphone 13">
                        <div class="card-body">
                          <p class="card-text">Enter the Lottery to have a change to win a new phone</p>
                          <button type="button" style="width: 5rem" class="btn btn-primary" id="phone">Bid</button>
                          <div id="phone-bids" class="h3 d-inline float-end"></div>
                        </div>
                      </div>
                </div>
                <div class="col-4 d-flex justify-content-center">
                    <div class="card" style="width: 18rem;">
                        <img src="./images/laptop-image.jpeg" class="card-img-top" alt="Photo of an IMac">
                        <div class="card-body">
                          <p class="card-text">Enter the Lottery to have a change  to win a new laptop</p>
                          <button type="button" style="width: 5rem" class="btn btn-primary" id="laptop">Bid</button>
                          <div id="laptop-bids" class="h3 d-inline float-end"></div>
                        </div>
                      </div>
                </div>
            </div>
            <div class="row p-5">
                <div class="col-6">
                    <form>
                        <div class="mb-3">
                          <label for="current-user-acc" class="form-label">Current User Account</label>
                          <input class="form-control" id="current-user-acc" type="text" placeholder="Current User Account here..." disabled>
                          <div class="form-text">
                            Your address will be displayed here
                          </div>
                        </div>
                    </form>
                </div>
                <div class="col-6">
                    <form>
                        <div class="mb-3">
                            <label for="owner-acc" class="form-label">Owner's Account</label>
                            <input class="form-control" id="owner-acc" type="text" placeholder="Owner Account here..." disabled>
                            <div class="form-text">
                            Contract's owner address will be displayed here
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row p-5">
                <div class="col-6">
                    <button type="button" id="reveal" style="width: 10rem" class="btn btn-primary">Reveal</button>
                </div>
                <div class="col-6">
                    <div>
                        <h5 id="contract-price-amount" class="d-inline align-middle">Current Balance: 0 Ether</h5>
                        <button id="withdraw" type="button" style="width: 10rem" class="btn btn-success  float-end">Withdraw</button>
                    </div>
                </div>
            </div>    
            <div class="row p-5">
                <div class="col-6">
                    <button type="button" id= "winner"  style="width: 10rem" class="btn btn-primary">Am I Winner</button>
                    <div id="winner-items" class="d-inline ps-3 align-middle h5"></div>
                </div>
                <div class="col-6">
                    <button type="button" id="declear-winner" style="width: 10rem" class="btn btn-success  float-end">
                        Declear Winner</button>
                </div>
            </div> 
        </div>
        <script src="web3.min.js"></script>
        <script src="contractAbi.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script>

            window.addEventListener('load', async () => {
            if (window.ethereum) {
                const web3 = new Web3(window.ethereum);
                try {
                    // Request account access if needed
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    // Acccounts now exposed
                } catch (error) {
                    console.error(error);
                }
                // Legacy dapp browsers...
            } 
        });
        if (typeof web3 != 'undefined') {
            web3 = new Web3(web3.currentProvider);
        }

        var fromAddress;
        web3.eth.getAccounts((error, accounts) => {
            if (error) {
                console.log('error:' + error);
                return;
            } else {
                fromAddress = accounts[0];
                $('#current-user-acc').val(fromAddress);
            }
        });

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                web3.eth.getAccounts((error, accounts) => {
                    if (error) {
                        console.log('error:' + error);
                        return;
                    } else {
                        fromAddress = accounts[0];
                        $('#current-user-acc').val(fromAddress);
                    }
                });
            });
        }

        //change this to the ACTUAL contract address that you created on truffle migrate
        var contractAddress = "0xAfeE7c254375F7bF05B521F9ce4329977a4b9bAf";
        var LotteryContract = new web3.eth.Contract(abi, contractAddress);

        var onwerAddress = LotteryContract.methods.beneficiary().call();
        onwerAddress.then(function(result){
            $('#owner-acc').val(result);
        })

        var amount = web3.eth.getBalance(contractAddress);
        amount.then(function(result){
            console.log('balance: ' + result);
            $('#contract-price-amount').html('Currect Balance: ' + web3.utils.fromWei(result)+ ' Ether');
        });

        $('#car').click(async() =>{
            await LotteryContract.methods.bid(0).send({
                from: fromAddress,
                value: web3.utils.toWei('0.01','ether')
            });
            alert('bid was made for the car lottery');
            var amount = web3.eth.getBalance(contractAddress);
            amount.then(function(result){
                console.log('balance: ' + result);
                $('#contract-price-amount').html('Currect Balance: ' + web3.utils.fromWei(result)+ 'Ether');
            });
        });

        $('#phone').click(async() =>{
            await LotteryContract.methods.bid(1).send({
                from: fromAddress,
                value: web3.utils.toWei('0.01','ether')
            });

            alert('bid was made for the phone lottery');
            var amount = web3.eth.getBalance(contractAddress);
            amount.then(function(result){
                console.log('balance: ' + result);
                $('#contract-price-amount').html('Currect Balance: ' + web3.utils.fromWei(result)+ 'Ether');
            });

        });

        $('#laptop').click(async() =>{
            var laptop = await LotteryContract.methods.bid(2).send({
                from: fromAddress,
                value: web3.utils.toWei('0.01','ether')
            });

            alert('bid was made for the laptop lottery');
            var amount = web3.eth.getBalance(contractAddress);
            amount.then(function(result){
                console.log('balance: ' + result);
                $('#contract-price-amount').html('Currect Balance: ' + web3.utils.fromWei(result)+ 'Ether');
            });
        });

        $('#reveal').click(async() =>{
            car_bids =  LotteryContract.methods.reveal(0).call();
            car_bids.then(function(result){
                console.log(result);
                $('#car-bids').html(result);
            });
            phone_bids = LotteryContract.methods.reveal(1).call();
            phone_bids.then(function(result){
                console.log(result);
                $('#phone-bids').html(result);
            });
            laptop_bids = LotteryContract.methods.reveal(2).call();
            laptop_bids.then(function(result){
                console.log(result);
                $('#laptop-bids').html(result);
            });
        })

        $("#withdraw").click(async() =>{
            withdraw = LotteryContract.methods.withdraw().send({
                from: fromAddress
            });
            withdraw.then(function(result){
                alert('Withdraw was successful');
                var amount = web3.eth.getBalance(contractAddress);
                amount.then(function(result){
                    console.log('balance: ' + result);
                    $('#contract-price-amount').html('Currect Balance: ' + web3.utils.fromWei(result)+ 'Ether');
                });
            })
        })

        $('#winner').click(async() => {
            var receipt = await LotteryContract.methods.am_i_winner().send({
                from: fromAddress
            });
            console.log(receipt.events);
            won_items = receipt.events.won_item_counter.returnValues['counter'];
            $('#winner-items').html('You have won ' + won_items + ' items out of the lottery');
        });
        
        $('#declear-winner').click(async() =>{
            await LotteryContract.methods.revealWinners().send({
                from: fromAddress
            }, (error,results) => {
                if (error) {
                        console.log(errors)
                    }
                    else {
                        alert('draw was made');
                    }
                }
            )
        });
        </script>
    </body>
</html>